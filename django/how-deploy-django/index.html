<!DOCTYPE html>
<html lang="Farsi">
<head>
  <title>سروش صفری | نحوه دیپلوی کردن پروژه جنگو</title>

  <meta charset="utf-8">
  <meta name="description" content="سلام ، این وبلاگ منه">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:type" content="website">
  <meta property="og:title" content="نحوه دیپلوی کردن پروژه جنگو">
  <meta property="og:url" content="https://koky.ir/django/">
  <meta property="og:site_name" content="سروش صفری">
  <meta property="og:description" content="&lt;p&gt;مقدمه

یکی از چیزایی که برای خیلی از دولوپر ها سوال هست این که یه پروژه جنگو رو چطوری روی هاست پیاده سازی (deploy) کنیم . اگه این برای شما هم سوال هست در ادامه همراه باشین .

من توی این اموزش برای دیپلوی کردن جنگو از ابزار زیر استفاده میکنم :

ubuntu server : سروری که من برای پروژه در نظر گرفتم ubuntu 18.04 هست
nginx : به عنوان وب سرور
Postgres : به عنوان دیتابیس پروژه
Gunicorn : برای ارتباط پروژه با nginx

در نهایت اگه شما تصمیم به استفاده از ابزارهای دیگه ای به غیر از مواردی که در بالا ذکر شده رو دارین ٬ میتونین از این اموزش استفاده کنین فقط توی اون قسمت کاری مشابه به کاری که من انجام دادم ر&lt;/p&gt;">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="نحوه دیپلوی کردن پروژه جنگو">
  <meta name="twitter:description" content="&lt;p&gt;مقدمه

یکی از چیزایی که برای خیلی از د...">

  <link rel="alternative" href="/djangoatom.xml" title="سروش صفری" type="application/atom+xml">
  <link rel="short icon" href="">
  <link rel="stylesheet" href="/static/theme/sallar/css/style.css" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115996537-1"></script>
	<script>
  	window.dataLayer = window.dataLayer || [];
  	function gtag(){dataLayer.push(arguments);}
  	gtag('js', new Date());

  	gtag('config', 'UA-115996537-1');
	</script>


</head>
<body>

<!-- Header -->
<header>
  <section class="container">
    <nav>
      <h1>
        <a href="/" class="logo">سروش صفری</a>
      </h1>
      <ul>
        

          <li><a href="/python/" target="python">آموزش پایتون</a></li>
          <li><a href="/django" target="django">آموزش جنگو</a></li>
          <li><a href="/farsi/">فارسی</a></li>
          <li><a href="/blog">English</a></li>
        
      </ul>
    </nav>
  </section>
</header>
<!-- /Header -->

<section id="content" class="container">

  <article id="how-deploy-django" class="article article-type-post" itemscope itemprop="blogPost">
    <h2 class="title" itemprop="name">نحوه دیپلوی کردن پروژه جنگو</h2>

    
      <h4 class="time">
    <time datetime="2020-01-16 12:37:01" itemprop="datePublished">پنج‌شنبه، ۲۶ دی ۱۳۹۸</time>
  </h4>
    

    <section class="content">
    <a name="more"></a>
<h1 id="مقدمه">مقدمه</h1>

<p>یکی از چیزایی که برای خیلی از دولوپر ها سوال هست این که یه پروژه جنگو رو چطوری روی هاست پیاده سازی (deploy) کنیم . اگه این برای شما هم سوال هست در ادامه همراه باشین .</p>

<p>من توی این اموزش برای دیپلوی کردن جنگو از ابزار زیر استفاده میکنم :</p>

<ul>
<li>ubuntu server : سروری که من برای پروژه در نظر گرفتم ubuntu 18.04 هست</li>
<li>nginx : به عنوان وب سرور</li>
<li>Postgres : به عنوان دیتابیس پروژه</li>
<li>Gunicorn : برای ارتباط پروژه با nginx</li>
</ul>

<p>در نهایت اگه شما تصمیم به استفاده از ابزارهای دیگه ای به غیر از مواردی که در بالا ذکر شده رو دارین ٬ میتونین از این اموزش استفاده کنین فقط توی اون قسمت کاری مشابه به کاری که من انجام دادم رو با ابزار مورد نظر خودتون  انجام بدین و در اصل مراحل یکی هست .</p>

<p><strong>( من توی این پست یه سری از کلمه ها رو به زبان انگیلیسی نوشتم چون براشون واژه معادل فارسی پیدا نکردم ٬ اگه پیشنهادی برای هرکدوم داشتین توی قسمت کامنت های این پست برام بنویسن که کلمه هارو تغییربدم)</strong></p>

<h3 id="نصب_نیازمندی_های_سرور_:">نصب نیازمندی های سرور :</h3>

<p>برای شروع ما نیازمند یه سری package هستیم که روی سرور نصب کنیم . دستورات زیر رو داخل سرور خودتون وارد کنید :</p>

<p><strong>( دقت کنید نیازی به کپی کردن علامت $ نیست )</strong></p>

<pre><code class="language-python">$   sudo apt update
$   sudo apt install python3-pip python3-dev libpq-dev postgresql postgresql-contrib nginx curl
</code></pre>

<p>توی دستورات بالا اول ما سرور رو اپدیت کردیم و در دستور دوم python , Postgres , nginx و curl رو روی سرور نصب کردیم .</p>

<h3 id="ساخت_دیتابیس_:">ساخت دیتابیس :</h3>

<p>برای استفاده از Postgres  به عنوان دیتابیس پروژه ما نیاز به ساخت یک دیتابیس و کاربر هستیم ٬ پس دراین قسمت ما یک دیتابیس و یک کاربر میسازیم که بتونیم پروژه جنگو رو به Postgres متصل کنیم . </p>

<p>در اولین مرحله ما باید database برای پروژه بسازیم اما قبلش باید به کامند لاین postgresql  وصل شدیم .  برای این کار دستور زیر رو وارد کنید :</p>

<pre><code class="language-python">$   sudo -u postgres psql 
</code></pre>

<p>بعد از متصل شدن به postgresql ما یک دیتابیس میسازیم ٬دستور زیر رو وارد کنید :</p>

<p>( به جای myproject که اسم دیتابیس من میباشد ٬ شما هر اسمی که میخواین رو وارد کنید )</p>

<pre><code class="language-python">postgres=# CREATE DATABASE myproject;
</code></pre>

<p>حال باید یه کاربر جدید برای دیتابسی که ساختیم ایجاد کنیم ٬ برای این کار دستور زیر را وارد کنید :</p>

<p>(  به جای myprojectuser که username کاربر میباشد و password که رمز عبور این کاربر هست ٬ شما  username و پسورد داخواه خودتون رو وارد کنید ) </p>

<p>دقت کنید که <strong>این اطلاعاتی رو که وارد میکنید در جایی یادداشت کنید</strong> .</p>

<pre><code class="language-python">postgres=# CREATE USER myprojectuser WITH PASSWORD 'password';
</code></pre>

<p>حالا که کاربر دیتابس شما ساخته شد ما باید یه سری تنظیمات که با جنگو سازگار هست رو به کاربر دیتابیس اضافه کنیم .</p>

<p>( به جای myprojectuser شما باید username که در قسمت بالا وارد کردین رو قرار بدین )</p>

<pre><code class="language-python">postgres=# ALTER ROLE myprojectuser SET client_encoding TO 'utf8';
postgres=# ALTER ROLE myprojectuser SET default_transaction_isolation TO 'read committed';
postgres=# ALTER ROLE myprojectuser SET timezone TO 'UTC';
</code></pre>

<p>حالا ما یه دیتابیس ساختیم و یک کاربر ٬ الان باید این کاربر رو به دیتابیس که در مرحله اول ساختیم وصل کنیم . برای این کار :</p>

<p>( به جای myproject شما باید اسم دیتابیس خودتون رو وارد کنید و به جای myprojectuser شما باید username کاربری که ساختین رو قرار بدین  )</p>

<pre><code class="language-python">postgres=# GRANT ALL PRIVILEGES ON DATABASE myproject TO myprojectuser;
</code></pre>

<p>و در اخر هم برای خروج از prompt دیتابیس دستور زیر رو وارد کنید :</p>

<pre><code class="language-python">postgres=# \q
</code></pre>

<h3 id="ایجاد_یک_python_virtual_environment_برای_پروژه_:">ایجاد یک Python Virtual Environment برای پروژه :</h3>

<p>ما برای نصب package ها مربوط به پروژه از Virtual Environment استفاده میکنیم ٬ اگه نمیدونین Virtual Environment چی هست توصیه میکنم برین توی گوگل سرچ کنین و یادش بگیرین :)</p>

<p>خوب برای شروع نیاز داریم Virtual Environment رو روی سرور نصب کنیم :</p>

<pre><code class="language-python">$   sudo -H pip3 install --upgrade pip
$   sudo -H pip3 install virtualenv
</code></pre>

<p>حالا باید پوشه برای ساخت Virtual Environment و پروژه جنگو ایجاد کنیم و به داخل اون پوشه بریم :</p>

<p>( به جای myprojectdir که اسم پوشه میباشد ٬ شما اسم دلخواه خودتون رو وارد کنید )</p>

<pre><code class="language-python">$   mkdir ~/myprojectdir
$   cd ~/myprojectdir
</code></pre>

<p>حال برای ساخت یک Virtual Environment دستور زیر رو وارد کنید :</p>

<p>( به جای myprojectenv که اسم Virtual Environment ما میباشد ٬ شما اسم دلخواه خودتون رو وارد کنید )</p>

<pre><code class="language-python">$   virtualenv myprojectenv
</code></pre>

<p>حال که Virtual Environment ما ساخته شد ٬ برای فعال سازی اون دستور زیر رو وارد کنید :</p>

<p>( به جای myprojectenv که اسم Virtual Environment  میباشد ٬ شما اسمی که در دستور بالا وارد کردین رو قرار بدین )</p>

<pre><code class="language-python">$   source myprojectenv/bin/activate
</code></pre>

<p>تا اینجای کار ما یک Virtual Environment ساختیم و فعالش کردیم ٬ الان میتونیم تمام package های مورد نیاز خودمون از قبیل خود django رو توی این Virtual Environment نصب کنیم :</p>

<pre><code class="language-python">$   pip install django gunicorn psycopg2-binary
</code></pre>

<h3 id="ساخت_و_انجام_تنظیمات_پروژه_جنگو_:">ساخت و انجام تنظیمات پروژه جنگو :</h3>

<p>دقت داشته باشین که من در این بخش یک پروژه جدید جنگو میسازیم که اگه شما از قبل روی کامپوتر خودتون پروژه رو ساختین بعضی از کارهای این قسمت رو نیاز نیست انجام بدین و فقط کل پروژه با استفاده github یا ابزار های دیگه به سرور منتقل کنین .</p>

<p>توی اولین گام یه پروژه جدید میسازیم :</p>

<p>( به جای myproject که اسم پروژه ما میباشد ٬ شما اسم دلخواه خودتون رو وارد کنید )</p>

<pre><code class="language-python">$   django-admin.py startproject myproject .
</code></pre>

<p>حالا برای انجام تنظیمات مورد نیاز جنگو باید فایل settings.py رو تغییر بدیم . برای این کار :</p>

<p>( به جای myprojectdir که اسم پوشه اصلی و myproject که اسم پروژه ما میباشد ٬ شما مقادیری که در بالا وارد کردین رو قرار بدین )</p>

<pre><code class="language-python">$   nano ~/myprojectdir/myproject/settings.py
</code></pre>

<p>اگه به درستی این مراحل رو طی کرده باشین ٬ میبینین که وارد یه ویرایشگر متن شدین که محتویات فایل settings.py پروژه در اون قرار داره . حالا  قسمت ALLOWED_HOSTS رو شکل زیر تغییر بدین :</p>

<p>( شما باید به جای your_server_domain_or_IP که ادرس دامنه یا ip سرور میباشد باید دامنه یا ip سرور خودتون رو وارد کنید )</p>

<pre><code class="language-python">ALLOWED_HOSTS = ['your_server_domain_or_IP', 'localhost']
</code></pre>

<p>حال کمی پایین تر برین و قسمت DATABASES رو به شکل زیر تغییر بدین :</p>

<p>دقت کنید که جلوی مقدار 'NAME' باید اسم دیتابیسی که ساختیم و  جلوی 'USER' نام کاربری که ساختین و همین طور در جلوی 'PASSWORD' رمز عبور کاربر دیتابیس که در بالا وارد کردین رو قرار بدین .</p>

<pre><code class="language-python">DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'myproject',
        'USER': 'myprojectuser',
        'PASSWORD': 'password',
        'HOST': 'localhost',
        'PORT': '',
    }
}
</code></pre>

<p>حال در پایین این فایل درست زیر '/STATIC_URL = '/static مقدار زیر رو وارد کنید :</p>

<pre><code class="language-python">STATIC_ROOT = os.path.join(BASE_DIR, 'static/')
</code></pre>

<p>حالا با  نگه داشتن  ترکیبی control و x کیبورد این فایل رو ذخیره کنین .</p>

<p>در این قسمت باید جداول دیتابیس مربوط به جنگو رو بسازیم :</p>

<pre><code class="language-python">$   python manage.py makemigrations
$   python manage.py migrate
</code></pre>

<p>حال یه super user برای دسترسی به admin panel جنگو میسازیم :</p>

<pre><code class="language-python">$   python manage.py createsuperuser
</code></pre>

<p>یه نکته مهم در اینجا هست که برای اینکه nginx بتونه css های پروژه رو serve کنه ما باید یه پوشه برای تمام css ها بسازیم و css ها رو داخل اون قرار بدیم و به nginx مسیر این پوشه رو بدیم . جنگو برای ساخت این پوشه و انتقال فایل های css یه دستور اماده داره که ازون استفاده میکنیم ٬ در اصل این دستور داخل root پروژه یه فایل با نام static می سازه و تمام css ها رو داخل این فایل انتقال میده ٬ برای این کار دستور زیر رو وارد کنید :</p>

<p><strong>(در نظر بگیرین در هر زمان که شما تغییری در css های پروژه میدین یا فایل css جدیدی اضافه میکنید ٬ باید این دستور رو دوباره بزنین )</strong></p>

<pre><code class="language-python">$   python manage.py collectstatic
</code></pre>

<p>حالا برای تست پروژه باید پورت 8000 سرور رو به اصطلاح باز کنیم ٬ برای اینکار دستور زیر رو وارد کنید :</p>

<pre><code class="language-python">$   sudo ufw allow 8000
</code></pre>

<p>حالا برای اجرای پروژه دستور زیر رو وارد کنید :</p>

<pre><code class="language-python">$   python manage.py runserver 0.0.0.0:8000
</code></pre>

<p>کار تمام است . حالا اگه داخل مرورگر ادرس زیر رو وارد کنید :</p>

<pre><code class="language-url">http://server_domain_or_IP:8000
</code></pre>

<p>بعد از این کار باید داخل مرورگر صفحه زیر رو ببینید :</p>

<p><img src="/django/images/django_index.jpg" alt="xcode" id="xcode"> </p>

<p>اگه همه چیز درست بود کلید ترکیبی <strong>CTRL-C</strong>  رو بزنین .</p>

<h3 id="تست_کردن_gunicorn_:">تست کردن Gunicorn :</h3>

<p>حالا وقتش رسیده با استفاده از gunicorn پروژه رو تست کنیم . برای این کار :</p>

<p>( به جای myproject اسم پروژه خودتون رو وارد کنید )</p>

<pre><code class="language-python">$   gunicorn --bind 0.0.0.0:8000 myproject.wsgi
</code></pre>

<p>و دوباره توی مرورگر ادرس زیر رو وارد کنید و باید صفحه ای مثل قبل رو مشاهده کنید‌:</p>

<pre><code>http://server_domain_or_IP:8000
</code></pre>

<p>اگه همه چیز درست بود کلید ترکیبی <strong>CTRL-C</strong>  رو بزنین .</p>

<h3 id="ساخت_فایل_socket_و_service_برای_gunicorn_:">ساخت فایل socket و service برای Gunicorn :</h3>

<p>ما در مرحله قبل gunicorn رو تست کردیم ولی برای پروژه از روش قبل بهتر استفاده نکنیم و به جاش از یه روش بهتر استفاده کنیم . برای این کار دستور زیر رو وارد کنید :</p>

<p><strong>(این دستور یه socket برای gunicorn می سازه .)</strong></p>

<pre><code class="language-python">$   sudo nano /etc/systemd/system/gunicorn.socket
</code></pre>

<p>بعد از زدن دستور بالا میبینیم که دوباره وارد محیط ویرایشگر متن شدیم اما این دفعه هیچی چیزی داخل صفحه نیست و ما باید اطلاعات رو واردش کنیم . برای این کار کدهای زیر رو وارد کنید :</p>

<pre><code class="language-python">[Unit]
Description=gunicorn socket

[Socket]
ListenStream=/run/gunicorn.sock

[Install]
WantedBy=sockets.target
</code></pre>

<p>حالا با استفاده کلید های ترکیبی <strong>CTRL-X</strong> این فایل رو سیو کنید .</p>

<p>در گام بعدی احتیاج داریم فایل service که برای gunicorn هست رو بسازیم :</p>

<pre><code class="language-python">$   sudo nano /etc/systemd/system/gunicorn.service
</code></pre>

<p>حال در صفحه باز شده کدهای زیر رو وارد کنید :</p>

<p><strong>نکته بسیار مهم :</strong></p>

<ul>
<li><p>جلوی User باید نام کاربری ubuntu server که الان باهاش ssh کردین رو وارد کنین .</p></li>
<li><p>جلوی WorkingDirectory باید ادرس دقیق پوشه که پروژه شما در اون قرار داره رو وارد کنید .</p></li>
<li><p>جلوی ExecStart و به جای ادرس /home/sammy/myprojectdir/myprojectenv/  شما باید ادرس دقیق پوشه که توش Virtual Environment پروژه شما قرار داره رو بنویسن و به جای /myprojectenv/ باید اسم Virtual Environment که قبلا ساخته اید رو قرار بدین .</p></li>
<li><p>و در پایین همین بخش  ExecStart باید به جای کلمه (myproject)   در کد myproject.wsgi:application اسم پروژه که ساختین رو قرار بدین .</p>

<p>( زیاد سخت نیست و اگه کمی به کد پایین دقت کنید متوجه میشین که دقیقا باید چیکار کنین)</p></li>
</ul>

<pre><code>[Unit]
Description=gunicorn daemon
Requires=gunicorn.socket
After=network.target

[Service]
User=sammy
Group=www-data
WorkingDirectory=/home/sammy/myprojectdir
ExecStart=/home/sammy/myprojectdir/myprojectenv/bin/gunicorn \
          --access-logfile - \
          --workers 3 \
          --bind unix:/run/gunicorn.sock \
          myproject.wsgi:application

[Install]
WantedBy=multi-user.target
</code></pre>

<p>حالا با استفاده کلید های ترکیبی <strong>CTRL-X</strong> این فایل رو سیو کنید .</p>

<p>الان ما میتونیم فایل socket مه ساختیم رو اجرا کنیم . برای این کار دستورات زیر رو وارد کنید :</p>

<pre><code class="language-python">$   sudo systemctl start gunicorn.socket
$   sudo systemctl enable gunicorn.socket
</code></pre>

<h3 id="اضافه_کردن_تنظیمات_nginx:">اضافه کردن تنظیمات nginx:</h3>

<p>برای ساختن تنظیمات nginx کد زیر رو وارد کنید :</p>

<p>( به جای myproject یه اسم دلخواه میتونین قرار بدین )</p>

<pre><code class="language-python">$   sudo nano /etc/nginx/sites-available/myproject
</code></pre>

<p>در صفحه که جلوی شما قرار داره کدهای زیر رو وارد کنید :</p>

<pre><code>server {
    listen 80;
    server_name server_domain_or_IP;

    location = /favicon.ico { access_log off; log_not_found off; }
    location /static/ {
        root /home/sammy/myprojectdir;
    }

    location / {
        include proxy_params;
        proxy_pass http://unix:/run/gunicorn.sock;
    }
}
</code></pre>

<p><strong>نکته بسیار مهم :</strong></p>

<ul>
<li>در جلو server_name باید ادرس دامنه خودتون رو وارد کنید</li>
<li>در قسمت root /home/sammy/myprojectdir  به جای ادرس وارد شده ادرس دقیق پروژه خودتون رو وارد کنید .</li>
</ul>

<p>حالا با استفاده کلید های ترکیبی <strong>CTRL-X</strong> این فایل رو سیو کنید .</p>

<p>در گام بعدی کد زیر رو وارد کنید :</p>

<p>( به جای myproject اسمی که در مرحله قبل وارد کردید رو قرار بدین )</p>

<pre><code class="language-python">$   sudo ln -s /etc/nginx/sites-available/myproject /etc/nginx/sites-enabled
</code></pre>

<p>حالا دستور زیر رو وارد کنید تا تنظیمات به nginx اعمال بشه : </p>

<pre><code class="language-python">$   sudo nginx -t
$   sudo systemctl restart nginx
</code></pre>

<p>و در اخر کدهای زیر رو وارد کنید :</p>

<pre><code class="language-python">$   sudo ufw delete allow 8000
$   sudo ufw allow 'Nginx Full'
</code></pre>

<p>حالا مرورگر خودتون رو باز کنین و ادرس دامنه خودتون رو بزنین و باید دوباره صفحه ابتدایی جنگو رو مشاهده کنید .دقت کنید که نیازی به وارد کردن 8000 در اخر دامنه نیست . </p>

<p>تبریک میگم کار تمام است !</p>

<p>اگه مشکلی و یا غلط املایی در نوشتار این پست بود حتما داخل کامنت های این پست بنده رو در جریان قرار بدین تا اصلاح کنم .</p>

<p>خیلی خوشحال میشم نظراتتون رو با من به اشتراک بزارین و اگه این پست به دردتون خورد حتما با دیگران به اشتراک بزارین تا اون ها هم بتونن استفاده کنن .</p>

<p>موفق باشد .</p>
  </section>

<!-- AddToAny BEGIN -->
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_twitter"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>
<!-- AddToAny END -->

    
      <script>
var idcomments_acct = 'fe0e59c5d710febd7774428cee9eb164';
var idcomments_post_id;
var idcomments_post_url;
</script>
<span id="IDCommentsPostTitle" style="display:none"></span>
<script type='text/javascript' src='https://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
    
  </article>

</section>

<!-- Paging -->
<section class="pagination">
  <nav class="container">
    
      <a></a>
    
      <a class="extend next" rel="next" href="/django/بازیابی-رمز-عبور/">
        <i>-></i>
        <span>بازیابی رمز عبور</span>
      </a>
  </nav>
</section>
<!-- /Paging -->

<!-- /Content -->
<!-- Footer -->
<footer>
    <!--<section class="copyright">

    </section>-->
    <section class="container">
      <div class="delimiter">
        <a href="/" class="logo">
          <img src="/static/theme/sallar/img/logo.svg">
        </a>
      </div>
      <p>
        
          ۱۳۹۸<br>
          مطالب تحت لیسانس <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/" rel="license" target="_blank">کریتیو کامنز</a> منتشر می‌شوند.
        
        <br>
        powered with 💜 by <a href="https://miraxy.github.io">Mira</a>
      </p>
    </section>
</footer>
<!-- /Footer -->

<!-- Scripts -->
<script src="/static/theme/sallar/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>