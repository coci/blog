<!DOCTYPE html>
<html lang="English">
<head>
  <title>soroush safari | Django log management with Elastic and Kibana</title>

  <meta charset="utf-8">
  <meta name="description" content="soroush safari's Blog. Exploring python & Things.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Django log management with Elastic and Kibana">
  <meta property="og:url" content="https://koky.ir/blog">
  <meta property="og:site_name" content="soroush safari">
  <meta property="og:description" content="&lt;p&gt;log management play the most crucial role in any system. logs can tell us where bugs happened and also can determine useful information about system.

In this guide, I’m going to teach you how to create log management with EFK stack and then connect it to your python application. If you don’t have enough information about EFK, it stands for Elasticsearch, Filebeat, and Kibana that I'll explain them in more detail.

Elasticsearch :

Elasticsearch is an open source, full-text search and analysis engine.

Filebeat :

Filebeat is an open source tool that collect data and ship them to Elasticsearch&lt;/p&gt;">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Django log management with Elastic and Kibana">
  <meta name="twitter:description" content="&lt;p&gt;log management play the most crucial r...">

  <link rel="alternative" href="/blogatom.xml" title="soroush safari" type="application/atom+xml">
  <link rel="short icon" href="">
  <link rel="stylesheet" href="/static/theme/sallar/css/style.css" type="text/css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115996537-1"></script>
	<script>
  	window.dataLayer = window.dataLayer || [];
  	function gtag(){dataLayer.push(arguments);}
  	gtag('js', new Date());

  	gtag('config', 'UA-115996537-1');
	</script>


</head>
<body>

<!-- Header -->
<header>
  <section class="container">
    <nav>
      <h1>
        <a href="/" class="logo">soroush safari</a>
      </h1>
      <ul>
        
          <li><a href="/blog">Index</a></li>
          <li><a href="https://github.com/coci" target="_blank">github</a></li>
          <li><a href="/farsi/">persian</a></li>
        
      </ul>
    </nav>
  </section>
</header>
<!-- /Header -->

<section id="content" class="container">

  <article id="dajngo-log-efk" class="article article-type-post" itemscope itemprop="blogPost">
    <h2 class="title" itemprop="name">Django log management with Elastic and Kibana</h2>

    
      <h4 class="time">
    <time datetime="2020-08-01 10:11:42" itemprop="datePublished">Saturday, August 01, 2020</time>
  </h4>
    

    <section class="content">
    <a name="more"></a>
<p>log management play the most crucial role in any system. logs can tell us where bugs happened and also can determine useful information about system.</p>

<p>In this guide, I’m going to teach you how to create log management with EFK stack and then connect it to your python application. If you don’t have enough information about EFK, it stands for Elasticsearch, Filebeat, and Kibana that I'll explain them in more detail.</p>

<h3 id="elasticsearch_:">Elasticsearch :</h3>

<p>Elasticsearch is an open source, full-text search and analysis engine.</p>

<h3 id="filebeat_:">Filebeat :</h3>

<p>Filebeat is an open source tool that collect data and ship them to Elasticsearch.</p>

<h3 id="kibana_:">Kibana :</h3>

<p>Kibana is a visualization layer that works on top of Elasticsearch, providing users with the ability to analyze and visualize the data.</p>

<h2 id="objective_:">Objective :</h2>

<p>this is a glimpse overview about what's going on this guide that might help : the application will produce logs and store them in a specified path and then Filebeat ship that logs to our Elasticsearch, and with Kibana, which is a graphical interface, we can manage our logs.</p>

<p>Well, now you know about what we are going to do and why we choose them. Before we dive into the tutorial, I want to say that there are tons of tutorials on the internet about EFK. Still, all of them are base on regular installation, You might encounter some trouble to configure and connect them, so I decided to create a guide on docker. Let's get start.</p>

<h2 id="create_django_project_and_configuration_logging_system_:">Create Django project and configuration logging system :</h2>

<p>for the first step we are going to create simple Django application , follow steps :</p>

<pre><code class="language-bash">$   mkdir django_logs
$   cd /django_logs
</code></pre>

<p>and then install Django and create project :</p>

<pre><code class="language-bash">$  pip install django
$  django-admin startproject django_logs .
$  python3 manage.py startapp test_log
</code></pre>

<p>now modify /django_logs/settings.py :</p>

<pre><code class="language-python">....

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'test_log.apps.TestLogConfig',
]
</code></pre>

<p>and it's time adding to logging package into our project , so add these in /django_logs/settings.py :</p>

<pre><code class="language-python">LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'simple': {
            'format': '[%(asctime)s] %(levelname)s | %(funcName)s | %(name)s | %(message)s',
            'datefmt': '%Y-%m-%d %H:%M:%S',
        },
    },
    'handlers': {
        'logger': {
            'level': 'DEBUG',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': BASE_DIR + '/logs/test.log',
            'formatter': 'simple',
        }
    },
    'loggers': {
        'signal': {
            'handlers': ['logger'],
            'level': 'DEBUG',
        }
    }
}
</code></pre>

<p>just notice that the line :</p>

<pre><code class="language-python">....
'filename': BASE_DIR + '/logs/test.log' 
....
</code></pre>

<p>Tells Django where to store logs; you can modify this, but remember it because we tell to Filebeat where our data will store.</p>

<p>now let's create view that might manipulate log , so add these line to test_log/views.py :</p>

<pre><code class="language-python">from django.http import HttpResponse
from django.shortcuts import render
from .task import add

import logging

def index(request):
    logger = logging.getLogger("loggers")
    message = {
        'message' : "user visits index()"
    }
    logger.info(message)
    return HttpResponse("hello")
</code></pre>

<p>If you review our code, you will notice that every time user visits our view, Django will create a log with 'message': "user visits index()."</p>

<p>please visit our route once and if you go to "/logs/test.log" and see the content of test.log files you must encounter with something like this :</p>

<pre><code class="language-bash">[2020-07-25 04:39:33] INFO | index | t.views | {'message': 'user visits index()'}
</code></pre>

<p>ok we've done with Django . let's dive right into creating EFK stack .</p>

<h2 id="elastic___filebeat_and_kibana_:">Elastic , Filebeat and Kibana :</h2>

<p>As well I mentioned earlier, we use docker to cut off troubling with installation and configurations.</p>

<p>In other words, to manage three different tools ( Elastic, Filebeat, Kibana ), we must use docker-compose.</p>

<p>now create docker-compose.yml in your project directory and add these lines :</p>

<pre><code class="language-python">version: '2'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.8.0
    container_name: elasticsearch
    ports:
      - 9200:9200
      - 9300:9300
    environment:
      discovery.type: single-node
    networks:
      - efk

  kibana:
    image: docker.elastic.co/kibana/kibana:7.8.0
    ports:
      - 5601:5601
    networks:
      - efk
    links:
      - elasticsearch
    depends_on:
      - elasticsearch

  filebeat:
    image: docker.elastic.co/beats/filebeat:7.8.0
    volumes:
      - /path-to-filebeat.yml/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /path-to-logs-directory/logs:/usr/share/filebeat/logs
    environment:
      ELASTICSEARCH_URL: &lt;http://elasticsearch:9200&gt;
    networks:
      - efk
    links:
      - kibana
      - elasticsearch
    depends_on:
      - elasticsearch
networks:
  efk:
    driver: bridge
</code></pre>

<p>keep in mind that just modify these lines : </p>

<pre><code class="language-python">- /path-to-filebeat.yml/filebeat.yml: ....
- /path-to-logs-directory/logs: ....
</code></pre>

<p>we have our docker-compose configuration, now as you see we need to create filebeat.yml configuration, well, create filebeat.yml file in your project directory and add these lines :</p>

<pre><code class="language-python">filebeat.inputs:

- type: log
  enabled: true
  paths:
    - /usr/share/filebeat/logs/*.log

  multiline.pattern: '^\\['
  multiline.negate: true
  multiline.match: after

output.elasticsearch:
  hosts: ["&lt;http://elasticsearch:9200&gt;"]
</code></pre>

<p>well, it's time to fire up our work, open terminal and enter :</p>

<pre><code class="language-python">$  docker-compose up -d
</code></pre>

<p>( it just takes minutes )</p>

<h2 id="kibana_dashboard_:">Kibana dashboard :</h2>

<p>If everything is done correctly , you must see this dashboard after you open <a href="http://localhost:5601">localhost:5601</a> in browser:</p>

<p><img src="/blog/images/1.jpg" alt="block" id="block"></p>

<p>now navigate to Kibana→discover :</p>

<p><img src="/blog/images/2.jpg" alt="gitea" id="gitea"></p>

<p>then go to index patterns → create index pattern</p>

<p><img src="/blog/images/3.jpg" alt="gitea" id="gitea"></p>

<p>and then :</p>

<p><img src="/blog/images/4.jpg" alt="gitea" id="gitea"></p>

<p>now everything is done and you can see logs , just navigate to menu → observability → logs .</p>
  </section>

<!-- AddToAny BEGIN -->
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_twitter"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>
<!-- AddToAny END -->

    
      <script>
var idcomments_acct = 'edab4112dbf8f45d3904228b8f395f7d';
var idcomments_post_id;
var idcomments_post_url;
</script>
<span id="IDCommentsPostTitle" style="display:none"></span>
<script type='text/javascript' src='https://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
    
  </article>

</section>

<!-- Paging -->
<section class="pagination">
  <nav class="container">
    
      <a></a>
    
      <a class="extend next" rel="next" href="/blog/helloworld/">
        <i>-></i>
        <span>hello world</span>
      </a>
  </nav>
</section>
<!-- /Paging -->

<!-- /Content -->
<!-- Footer -->
<footer>
    <!--<section class="copyright">

    </section>-->
    <section class="container">
      <div class="delimiter">
        <a href="/" class="logo">
          <img src="/static/theme/sallar/img/logo.svg">
        </a>
      </div>
      <p>
        
        2020<br>
          Content is licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/" rel="license" target="_blank">Creative Commons</a>.
        
        <br>
        powered with 💜 by <a href="https://miraxy.github.io">Mira</a>
      </p>
    </section>
</footer>
<!-- /Footer -->

<!-- Scripts -->
<script src="/static/theme/sallar/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>